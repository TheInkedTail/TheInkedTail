<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Inked Tail - D&D Character Sheet</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet">

  <style>
    :root{
      --parchment:#f6efe2;
      --paper:#fffdf8;
      --ink:#2b1f17;
      --accent:#7b2f2f;
      --border:#66402c;
      --gold:#d5b67a;
    }
    html,body{height:100%;}
    body{font-family: 'IM Fell English', Georgia, serif;background:linear-gradient(180deg,var(--parchment),#efe6d8);color:var(--ink);margin:0;padding:0}
    .topbar{position:sticky;top:0;z-index:80;background:linear-gradient(180deg,var(--accent),#4f1a1a);color:white;padding:.5rem 1rem;border-bottom:4px solid rgba(0,0,0,0.25);box-shadow:0 6px 18px rgba(0,0,0,0.25)}
    .topbar a{color:rgba(255,255,255,0.95);text-decoration:none;padding:.35rem .6rem;border-radius:6px;font-weight:700}
    .topbar .btn{background:linear-gradient(180deg,var(--gold),#b88a40);padding:.4rem .7rem;border-radius:6px;color:#2b1f17;font-weight:700}
    .container{max-width:1200px;margin:1rem auto;padding:1rem}
    .sheet-section{background:var(--paper);border:3px solid var(--border);border-radius:12px;padding:1rem;box-shadow:0 10px 30px rgba(17,12,8,0.12);overflow:hidden;margin-bottom:1rem}
    .dnd-input{display:block;width:100%;padding:.45rem .6rem;border:1px solid rgba(0,0,0,0.12);border-radius:8px;background:linear-gradient(180deg,#fff,#fbf6ee);min-height:36px;box-sizing:border-box}
    textarea.dnd-input{min-height:3.4rem;resize:vertical}
    .portrait{width:150px;height:150px;border-radius:10px;overflow:hidden;border:4px solid var(--border);background:linear-gradient(180deg,#fffdf7,#fbf2df)}
    .portrait img{width:100%;height:100%;object-fit:cover;display:block}
    .ability-block{display:flex;flex-direction:column;align-items:center;padding:.6rem;border-radius:8px;border:1px dashed rgba(0,0,0,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(250,245,235,0.9))}
    .skill-proficiency{width:26px;height:26px;border-radius:6px;border:2px solid var(--accent);display:inline-grid;place-items:center;font-weight:700;cursor:pointer;user-select:none;background:linear-gradient(180deg,#fff,#f4efe2)}
    .skill-proficiency[data-pro="0"]{opacity:0.35}
    .list-stack{display:flex;flex-direction:column;gap:.6rem}
    .list-item{background:linear-gradient(180deg,#fff,#fbf6ee);border:2px solid rgba(0,0,0,0.06);padding:.6rem;border-radius:8px;display:flex;flex-direction:column;gap:.4rem}
    .small-btn{padding:.35rem .6rem;border-radius:6px;background:#efe7d1;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
    .row{display:flex;gap:.6rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.4rem}
    .field-title{font-size:0.85rem;color:rgba(0,0,0,0.6);margin-bottom:0.12rem}
    /* keep inputs looking the same but allow autosizing adjustments */
    .autosize{transition:font-size .08s linear}
    @media print{
      body{background:white;color:black}
      .topbar{display:none}
      .container{max-width:100%;padding:0}
      .sheet-section{border:none;box-shadow:none}
      .small-btn,.trash-btn{display:none}
    }
    @media (max-width:900px){
      .portrait{width:110px;height:110px}
      .row{flex-direction:column;align-items:stretch}
    }

    /* Inventory table styles — match theme */
    .inventory-table{width:100%;border-collapse:collapse;margin-top:.5rem;font-size:0.95rem}
    .inventory-table th,.inventory-table td{border:1px solid var(--border);padding:.3rem;text-align:left;background:transparent}
    .inventory-table th{background:linear-gradient(180deg,#efe0bb,#e0d4b7);font-weight:700}
    .notes{display:none;margin-top:.3rem;padding:.3rem;border:1px dashed var(--border);background:#faf7f0}
    .notes-open{display:block}
    .notes-btn{cursor:pointer;font-size:0.85rem;color:var(--accent);text-decoration:underline;background:none;border:none;padding:0}
    /* Spell tables */
    .spell-table{width:100%;border-collapse:collapse;margin-top:.5rem;font-size:0.95rem}
    .spell-table th,.spell-table td{border:1px solid var(--border);padding:.4rem;text-align:left;background:transparent;vertical-align:top}
    .spell-table th{background:linear-gradient(180deg,#efe0bb,#e0d4b7);font-weight:700}
    .spell-desc{width:100%;min-height:60px}
    /* Spellcasting row tweaks to keep remove button inside bounds */
    .spellcasting-row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem}
    .spellcasting-row > div{min-width:0}
    .spellcasting-row .control-group{display:flex;gap:.4rem;align-items:center}
    .remove-casting{padding:.3rem .5rem}

    /* New helper for vertical label-input rows used in Currency/Encumbrance */
    .label-row{display:flex;align-items:center;gap:0.6rem}
    .label-row .label-col{width:72px;flex:0 0 72px}
    .label-row .input-col{flex:1}
    @media (max-width:640px){
      .label-row{flex-direction:column;align-items:stretch}
      .label-row .label-col{width:auto;flex:unset}
    }

    /* Expandable textarea tweaks */
    textarea.expandable{overflow:hidden;resize:vertical;min-height:40px}

    /* Visual cue while dragging */
    .dragging { opacity: 0.5; }
    .drag-over { outline: 2px dashed rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container flex justify-between items-center">
      <nav class="flex gap-2 items-center">
        <a href="#char-info">Character</a>
        <a href="#abilities">Abilities</a>
        <a href="#combat">Combat</a>
        <a href="#spells">Spells</a>
        <a href="#inventory">Inventory</a>
        <a href="#details">Details</a>
        <a href="https://www.theinkedtail.com" target="_blank" rel="noopener">Mike's Website</a>
      </nav>
      <div class="flex gap-2">
        <button class="btn" onclick="saveCharacterSheet()"><i data-feather="save"></i> Save</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="text-center">
      <h1 style="font-family:'Cinzel',serif;font-size:28px;margin:0;color:var(--accent)">Dungeons & Dragons — Character Sheet</h1>
      <p style="margin:.2rem 0 .8rem;color:rgba(0,0,0,0.85)">Mike's HTML character sheet V1.2</p>
      <p style="margin:.2rem 0 .8rem;color:rgba(0,0,0,0.85)">Make your changes, click save, and open the new file in a browser.</p>
      <p style="margin:.2rem 0 .8rem;color:rgba(0,0,0,0.85)">Feel free to check out my website to read my fantasy book series.</p>
    </header>

    <!-- CHARACTER INFO -->
    <section id="char-info" class="sheet-section grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="row items-start">
        <div class="portrait" id="portrait-box"><img id="character-portrait" src="" alt="portrait"></div>
        <div style="flex:1">
          <div class="col">
            <div>
              <div class="field-title">Character Name</div>
              <input id="character-name" class="dnd-input text-2xl font-bold autosize" placeholder="Character Name">
            </div>
            <div class="grid grid-cols-2 gap-2">
              <div>
                <div class="field-title">Class & Level</div>
                <input id="character-class" class="dnd-input autosize" placeholder="Class & Level">
              </div>
              <div>
                <div class="field-title">Race</div>
                <input id="character-race" class="dnd-input autosize" placeholder="Race">
              </div>
              <div>
                <div class="field-title">Player</div>
                <input id="player-name" class="dnd-input autosize" placeholder="Player">
              </div>
              <div>
                <div class="field-title">Background</div>
                <input id="character-background" class="dnd-input autosize" placeholder="Background">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="col">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="field-title">Alignment</div>
              <input id="character-alignment" class="dnd-input autosize" placeholder="Alignment">
            </div>
            <div>
              <div class="field-title">XP</div>
              <input id="character-xp" class="dnd-input autosize" placeholder="XP">
            </div>
            <div>
              <div class="field-title">AC</div>
              <input id="character-ac" class="dnd-input autosize" placeholder="AC">
            </div>
            <div>
              <div class="field-title">Initiative</div>
              <input id="character-initiative" class="dnd-input autosize" placeholder="Initiative">
            </div>
            <div>
              <div class="field-title">Speed</div>
              <input id="character-speed" class="dnd-input autosize" placeholder="Speed">
            </div>
            <div>
              <div class="field-title">Proficiency</div>
              <input id="proficiency-bonus" class="dnd-input autosize" placeholder="Proficiency">
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="col">
          <div class="row">
            <div style="flex:1">
              <div class="field-title">Current HP</div>
              <input id="character-hp-current" class="dnd-input autosize" type="number" placeholder="Current HP">
            </div>
            <div style="flex:1">
              <div class="field-title">Max HP</div>
              <input id="character-hp-max" class="dnd-input autosize" type="number" placeholder="Max HP">
            </div>
          </div>
          <div>
            <div class="field-title">Hit Dice</div>
            <input id="character-hit-dice" class="dnd-input autosize" placeholder="Hit Dice">
          </div>
          <div class="row" style="align-items:center">
            <div style="flex:1">
              <div class="field-title">Portrait image URL</div>
              <input id="portrait-url" class="dnd-input autosize" placeholder="Portrait image URL">
            </div>
            <button class="small-btn" onclick="applyPortraitUrl()">Apply</button>
          </div>
          <input id="portrait-input" type="file" accept="image/*" class="mt-1" onchange="updatePortrait(this)">
        </div>
      </div>
    </section>

    <!-- ABILITIES / SKILLS / COMBAT -->
    <section id="abilities" class="sheet-section grid grid-cols-1 lg:grid-cols-4 gap-6">
      <div>
        <h3 class="font-bold">Ability Scores</h3>
        <div class="grid grid-cols-3 gap-2 mt-2" id="abilities-grid"></div>

        <div class="mt-4">
          <h4 class="font-semibold">Saving Throws</h4>
          <div id="saves-list" class="space-y-2 mt-2"></div>
        </div>

        <div class="mt-3">
          <div class="row">
            <label class="col">
              <span>Inspiration</span>
              <input type="checkbox" id="inspiration">
            </label>
            <label class="col">
              <span>Passive Perception</span>
              <input id="passive-perception" class="dnd-input" readonly>
            </label>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        <h3 class="font-bold">Skills</h3>
        <div id="skills-list" class="space-y-2 mt-2"></div>
      </div>

      <div>
        <h3 class="font-bold">Features & Traits</h3>
        <label class="text-sm mt-1">Class Features</label>
        <textarea id="class-features" class="dnd-input w-full h-28" placeholder="Class Features"></textarea>
        <label class="text-sm mt-2">Racial Traits</label>
        <textarea id="racial-traits" class="dnd-input w-full h-20" placeholder="Racial Traits"></textarea>
      </div>

      <div id="combat">
        <h3 class="font-bold">Combat</h3>
        <div>
          <label class="block text-sm">Weapons</label>
          <div id="weapons-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addWeapon()"><i data-feather="plus"></i> Add Weapon</button></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm">Armor</label>
          <div id="armor-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addArmor()"><i data-feather="plus"></i> Add Armor</button></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm">Passive Investigation</label>
          <input id="passive-investigation" class="dnd-input w-full" readonly>
        </div>
      </div>
    </section>

    <!-- SPELLS -->
    <section id="spells" class="sheet-section">
      <h3 class="font-bold">Spells</h3>
      <div class="grid grid-cols-1 gap-2 mt-2">
        <div id="spellcasting-list"></div>
        <div style="margin-top:.5rem"><button class="small-btn" id="add-casting-btn">+ Add Casting Ability</button></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold">Cantrips</h4>
          <table id="cantrips-table" class="spell-table"><thead><tr><th>Name</th><th>Level</th><th>Range</th><th>Duration</th><th>Description</th><th></th></tr></thead><tbody></tbody></table>
          <div class="mt-2"><button class="small-btn" onclick="addSpell('cantrip')"><i data-feather="plus"></i> Add Cantrip</button></div>
        </div>

        <div>
          <h4 class="font-semibold">Prepared Spells</h4>
          <table id="prepared-table" class="spell-table"><thead><tr><th>Name</th><th>Level</th><th>Range</th><th>Duration</th><th>Description</th><th></th></tr></thead><tbody></tbody></table>
          <div class="mt-2"><button class="small-btn" onclick="addSpell('prepared')"><i data-feather="plus"></i> Add Spell</button></div>
        </div>
      </div>
    </section>

    <!-- INVENTORY (REPLACED / IMPROVED) -->
    <section id="inventory" class="sheet-section">
      <h3 class="font-bold">Inventory</h3>

      <!-- Inventory containers render here -->
      <div id="inventory-containers" style="margin-top:.5rem;"></div>

      <!-- master add container -->
      <div style="margin-top:.75rem;">
        <button class="small-btn" onclick="promptAddContainer()">+ Add Container</button>
      </div>

      <!-- currency & encumbrance -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold">Currency</h4>

          <!-- Vertical stacked label rows with title on the left -->
          <div class="mt-2 space-y-2">
            <div class="label-row">
              <div class="label-col"><div class="field-title">CP</div></div>
              <div class="input-col"><input id="currency-cp" class="dnd-input autosize" placeholder="CP" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">SP</div></div>
              <div class="input-col"><input id="currency-sp" class="dnd-input autosize" placeholder="SP" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">EP</div></div>
              <div class="input-col"><input id="currency-ep" class="dnd-input autosize" placeholder="EP" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">GP</div></div>
              <div class="input-col"><input id="currency-gp" class="dnd-input autosize" placeholder="GP" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">PP</div></div>
              <div class="input-col"><input id="currency-pp" class="dnd-input autosize" placeholder="PP" type="number"></div>
            </div>
          </div>
        </div>

        <div>
          <h4 class="font-semibold">Encumbrance</h4>

          <!-- Vertical stacked label rows with title on the left -->
          <div class="mt-2 space-y-2">
            <div class="label-row">
              <div class="label-col"><div class="field-title">Carried</div></div>
              <div class="input-col"><input id="carried-weight" class="dnd-input autosize" placeholder="Carried" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">Max</div></div>
              <div class="input-col"><input id="max-capacity" class="dnd-input autosize" placeholder="Max" type="number"></div>
            </div>

            <div class="label-row">
              <div class="label-col"><div class="field-title">Status</div></div>
              <div class="input-col"><input id="encumbrance-status" class="dnd-input autosize" placeholder="Status" readonly></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes modal hidden until used (kept for backward compat but inventory now uses inline description box) -->
      <div id="item-notes-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:120;">
        <div style="background:var(--paper);border:3px solid var(--border);padding:1rem;border-radius:8px;max-width:700px;width:94%;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Item Notes</strong>
            <div>
              <button class="small-btn" onclick="closeNotesModal()">Close</button>
            </div>
          </div>
          <textarea id="item-notes-modal-text" class="dnd-input" style="margin-top:.6rem;min-height:180px;"></textarea>
          <div style="margin-top:.6rem;text-align:right;">
            <button class="small-btn" onclick="saveNotesModal()">Save</button>
          </div>
        </div>
        <div onclick="closeNotesModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.35)"></div>
      </div>

    </section>

    <!-- DETAILS -->
    <section id="details" class="sheet-section">
      <h3 class="font-bold">Character Details</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
        <div>
          <label class="text-sm">Appearance</label>
          <textarea id="character-appearance" class="dnd-input w-full h-40" placeholder="Appearance"></textarea>
        </div>
        <div>
          <label class="text-sm">Backstory</label>
          <textarea id="character-backstory" class="dnd-input w-full h-40" placeholder="Backstory"></textarea>
        </div>
        <div>
          <label class="text-sm">Vitals</label>
          <div class="grid grid-cols-2 gap-2 mt-1">
            <input id="detail-height" class="dnd-input autosize" placeholder="Height">
            <input id="detail-weight" class="dnd-input autosize" placeholder="Weight">
            <input id="detail-age" class="dnd-input autosize" placeholder="Age">
            <input id="detail-eyes" class="dnd-input autosize" placeholder="Eyes">
            <input id="detail-skin" class="dnd-input autosize" placeholder="Skin">
            <input id="detail-hair" class="dnd-input autosize" placeholder="Hair">
          </div>
          <label class="text-sm mt-2">Allies & Organizations</label>
          <textarea id="character-allies" class="dnd-input w-full h-24" placeholder="Allies & Organizations"></textarea>
        </div>
      </div>
    </section>
  </div>

<script>
feather.replace();
// Prevent browsers from restoring a previous scroll position on reload
try{ if('scrollRestoration' in history) history.scrollRestoration = 'manual'; }catch(e){}


// --- Core data for abilities & skills ---
const abilities = [
  {abbr:'STR',id:'str'}, {abbr:'DEX',id:'dex'}, {abbr:'CON',id:'con'},
  {abbr:'INT',id:'int'}, {abbr:'WIS',id:'wis'}, {abbr:'CHA',id:'cha'}
];

const skills = [
  {id:'acrobatics',label:'Acrobatics',ability:'dex'}, {id:'animal-handling',label:'Animal Handling',ability:'wis'},
  {id:'arcana',label:'Arcana',ability:'int'}, {id:'athletics',label:'Athletics',ability:'str'},
  {id:'deception',label:'Deception',ability:'cha'}, {id:'history',label:'History',ability:'int'},
  {id:'insight',label:'Insight',ability:'wis'}, {id:'intimidation',label:'Intimidation',ability:'cha'},
  {id:'investigation',label:'Investigation',ability:'int'}, {id:'medicine',label:'Medicine',ability:'wis'},
  {id:'nature',label:'Nature',ability:'int'}, {id:'perception',label:'Perception',ability:'wis'},
  {id:'performance',label:'Performance',ability:'cha'}, {id:'persuasion',label:'Persuasion',ability:'cha'},
  {id:'religion',label:'Religion',ability:'int'}, {id:'sleight-of-hand',label:'Sleight of Hand',ability:'dex'},
  {id:'stealth',label:'Stealth',ability:'dex'}, {id:'survival',label:'Survival',ability:'wis'}
];

// BUILDERS (only build if empty to prevent duplication on saved pages)
const abilitiesGrid = document.getElementById('abilities-grid');
if (abilitiesGrid && abilitiesGrid.children.length === 0) {
  abilities.forEach(a=>{
    const el = document.createElement('div'); el.className='ability-block';
    el.innerHTML = `<div style="font-weight:700">${a.abbr}</div>
      <input type="number" min="1" max="30" class="dnd-input ability-score text-center autosize" data-ability="${a.id}" value="10">
      <div>Mod: <span class="ability-mod">+0</span></div>`;
    abilitiesGrid.appendChild(el);
  });
}

const savesList = document.getElementById('saves-list');
if (savesList && savesList.children.length === 0) {
  abilities.forEach(a=>{
    const row = document.createElement('div'); row.className='row'; row.style.alignItems='center';
    row.innerHTML = `<div style="width:36px"><div class="skill-proficiency" data-skill="${a.id}-save" data-pro="0">–</div></div>
      <div style="flex:1;font-weight:700">${a.abbr} Save</div>
      <div style="width:48px;text-align:right;font-weight:700" id="${a.id}-save-mod">+0</div>`;
    savesList.appendChild(row);
  });
}

const skillsList = document.getElementById('skills-list');
if (skillsList && skillsList.children.length === 0) {
  skills.forEach(s=>{
    const row = document.createElement('div'); row.className='row'; row.style.alignItems='center';
    row.innerHTML = `<div style="width:36px"><div class="skill-proficiency" data-skill="${s.id}" data-pro="0">–</div></div>
      <div style="flex:1">${s.label} <span style="font-size:.8rem;color:rgba(0,0,0,0.45);">(${s.ability.toUpperCase()})</span></div>
      <div style="width:48px;text-align:right;font-weight:700" id="${s.id}-mod">+0</div>`;
    skillsList.appendChild(row);
  });
}

// Proficiency cycling and modifier calculations
function cyclePro(el){
  const cur = parseInt(el.getAttribute('data-pro')||'0'); const next = (cur+1)%4;
  el.setAttribute('data-pro',next);
  const icons = ['','½','●','★']; el.textContent = icons[next] || '';
  updateModifiers();
}
document.addEventListener('click',(e)=>{
  const el = e.target.closest('.skill-proficiency'); if(el) cyclePro(el);
});

function calcMod(score){ return Math.floor((score-10)/2); }

function updateModifiers(){
  const prof = parseInt(document.getElementById('proficiency-bonus').value)||0;
  document.querySelectorAll('.ability-score').forEach(inp=>{
    const score = parseInt(inp.value)||0; const mod = calcMod(score);
    inp.parentElement.querySelector('.ability-mod').textContent = (mod>=0?'+':'')+mod;
  });
  abilities.forEach(a=>{
    const base = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${a.id}"]`).value||10));
    const protEl = document.querySelector(`.skill-proficiency[data-skill="${a.id}-save"]`); const level = parseInt(protEl.getAttribute('data-pro')||0);
    let add=0; if(level===1) add=Math.ceil(prof/2); if(level===2) add=prof; if(level===3) add=prof*2;
    document.getElementById(`${a.id}-save-mod`).textContent = (base+add>=0?'+':'')+(base+add);
  });
  skills.forEach(s=>{
    const base = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${s.ability}"]`).value||10));
    const protEl = document.querySelector(`.skill-proficiency[data-skill="${s.id}"]`); const level = parseInt(protEl.getAttribute('data-pro')||0);
    let add=0; if(level===1) add=Math.ceil(prof/2); if(level===2) add=prof; if(level===3) add=prof*2;
    document.getElementById(`${s.id}-mod`).textContent = (base+add>=0?'+':'')+(base+add);
  });

  const perBase = calcMod(parseInt(document.querySelector('.ability-score[data-ability="wis"]').value||10));
  const perProt = parseInt(document.querySelector(`.skill-proficiency[data-skill="perception"]`).getAttribute('data-pro')||0);
  let perAdd=0; if(perProt===1) perAdd=Math.ceil(prof/2); if(perProt===2) perAdd=prof; if(perProt===3) perAdd=prof*2;
  document.getElementById('passive-perception').value = 10 + perBase + perAdd;

  const invBase = calcMod(parseInt(document.querySelector('.ability-score[data-ability="int"]').value||10));
  const invProt = parseInt(document.querySelector(`.skill-proficiency[data-skill="investigation"]`).getAttribute('data-pro')||0);
  let invAdd=0; if(invProt===1) invAdd=Math.ceil(prof/2); if(invProt===2) invAdd=prof; if(invProt===3) invAdd=prof*2;
  document.getElementById('passive-investigation').value = 10 + invBase + invAdd;

  // update all spellcasting rows
  document.querySelectorAll('.spellcasting-row').forEach(row=>{
    const spellAbility = row.querySelector('.spellcasting-select').value;
    const spellMod = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${spellAbility}"]`).value||10));
    const saveEl = row.querySelector('.spell-save-dc');
    const atkEl = row.querySelector('.spell-attack-bonus');
    if(saveEl) saveEl.value = 8 + prof + spellMod;
    if(atkEl) atkEl.value = (prof + spellMod >= 0 ? '+' : '') + (prof + spellMod);
  });
}
document.addEventListener('input',(e)=>{ if(e.target && (e.target.classList.contains('ability-score')||e.target.id==='proficiency-bonus')) updateModifiers(); });

// --- Field titles (show placeholder next to fields) and autosize behavior ---
function annotateFieldsAndAutosize(){
  const selector = 'input[placeholder], textarea[placeholder]';
  document.querySelectorAll(selector).forEach(el=>{
    if(!el.parentElement) return;
    if(el.closest('.label-row') || el.closest('.label-col')) return;
    const prev = el.previousElementSibling;
    if(prev && (prev.classList && prev.classList.contains('field-title') || prev.tagName === 'LABEL')) {
      if(prev.classList && prev.classList.contains('field-title') && !prev.textContent.trim()){
        prev.textContent = el.getAttribute('placeholder') || '';
      }
      return;
    }
    if(el.closest('.field-wrapper')) return;
    const label = document.createElement('div');
    label.className = 'field-title';
    label.textContent = el.getAttribute('placeholder') || '';
    el.parentElement.insertBefore(label, el);
  });

  document.querySelectorAll('.field-title').forEach(ft=>{
    const p = ft.previousElementSibling;
    if(p && p.classList && p.classList.contains('field-title')){
      ft.remove();
    }
  });

  const singleInputs = document.querySelectorAll('input.dnd-input');
  singleInputs.forEach(inp=>{
    if(inp._autosizeBound) return;
    inp._autosizeBound = true;
    inp.classList.add('autosize');
    const fit = ()=>{
      try{
        const style = window.getComputedStyle(inp);
        const tmp = document.createElement('span');
        tmp.style.visibility='hidden';
        tmp.style.whiteSpace='pre';
        tmp.style.font = style.font;
        tmp.textContent = inp.value || inp.getAttribute('placeholder') || '';
        document.body.appendChild(tmp);
        const needed = tmp.clientWidth + 12;
        document.body.removeChild(tmp);
        const available = Math.max(20, inp.clientWidth - 10);
        let fz = parseFloat(style.fontSize) || 16;
        const min = 10; const max = 22;
        if(needed > available){
          const scale = available / needed;
          const newSize = Math.max(min, Math.min(max, Math.floor(fz * scale)));
          inp.style.fontSize = newSize + 'px';
        } else {
          inp.style.fontSize = '';
        }
      }catch(e){}
    };
    inp.addEventListener('input', fit);
    setTimeout(fit,50);
    window.addEventListener('resize', fit);
  });
}

/* Expandable textarea auto-resize */
function autoExpandTextarea(el){
  if(!el) return;
  el.style.height = 'auto';
  const newHeight = Math.max(el.scrollHeight, 40);
  el.style.height = newHeight + 'px';
}
function bindExpandableTextareas(root=document){
  const els = root.querySelectorAll('textarea.expandable');
  els.forEach(t=>{
    if(t._expandBound) return;
    t._expandBound = true;
    t.style.overflow = 'hidden';
    t.addEventListener('input', ()=>autoExpandTextarea(t));
    setTimeout(()=>autoExpandTextarea(t), 30);
  });
}

/* ========== Drag-and-drop reordering for spell tables (fixed to allow text selection) ========== */
/* Minimal, robust implementation that reorders rows (within same tbody).
   IMPORTANT: prevent dragstart when the user clicked inside a form control so text selection and double-click work. */
let _dragCounter = 1;
function makeRowDraggable(tr){
  if(!tr) return;
  // Give each row a stable id if it doesn't have one
  if(!tr.dataset.dragId) tr.dataset.dragId = 'spellrow-' + (_dragCounter++);

  // On mousedown/touchstart decide whether this row should be draggable.
  // If the user clicked inside a form control, disable draggable so text selection works.
  const decideDraggable = (e) => {
    // if target is inside an input/textarea/select, disable dragging
    if(e.target && e.target.closest && e.target.closest('input, textarea, select')) {
      tr.draggable = false;
    } else {
      tr.draggable = true;
    }
  };
  tr.addEventListener('mousedown', decideDraggable);
  tr.addEventListener('touchstart', decideDraggable, {passive:true});

  // dragstart: if for some reason dragstart still fires from a control, bail out early.
  tr.addEventListener('dragstart', (e)=>{
    if(e.target && e.target.closest && e.target.closest('input, textarea, select')) {
      e.preventDefault();
      return;
    }
    tr.classList.add('dragging');
    e.dataTransfer.setData('text/plain', tr.dataset.dragId);
    e.dataTransfer.effectAllowed = 'move';
  });

  tr.addEventListener('dragend', ()=>{ tr.classList.remove('dragging'); cleanupDragOver(tr.parentElement); });

  tr.addEventListener('dragenter', (e) => {
    const dragging = document.querySelector('.dragging');
    if(!dragging) return;
    if(tr === dragging) return;
    tr.classList.add('drag-over');
  });
  tr.addEventListener('dragleave', ()=>{ tr.classList.remove('drag-over'); });
}


// Ensure tbody accepts drops and reorders rows
function enableSpellDnD(tbody){
  if(!tbody || tbody._dndEnabled) return;
  tbody._dndEnabled = true;

  tbody.addEventListener('dragover', (e)=>{
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const afterEl = getDragAfterElement(tbody, e.clientY);
    Array.from(tbody.querySelectorAll('tr')).forEach(r=>r.classList.remove('drag-over-after'));
    if(afterEl && afterEl !== tbody) afterEl.classList.add('drag-over-after');
  });

  tbody.addEventListener('drop', (e)=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    if(!id) return;
    const dragged = tbody.querySelector(`[data-drag-id="${id}"]`);
    if(!dragged) return;
    const afterEl = getDragAfterElement(tbody, e.clientY);
    if(!afterEl || afterEl === dragged) {
      tbody.appendChild(dragged);
    } else {
      tbody.insertBefore(dragged, afterEl);
    }
    Array.from(tbody.querySelectorAll('tr')).forEach(r=>r.classList.remove('drag-over','drag-over-after'));
  });

  function getDragAfterElement(container, y) {
    const rows = [...container.querySelectorAll('tr:not(.dragging)')];
    return rows.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element || null;
  }
}

function cleanupDragOver(tbody){
  if(!tbody) return;
  tbody.querySelectorAll('.drag-over, .drag-over-after').forEach(el=>el.classList.remove('drag-over','drag-over-after'));
}
/* ===================================================== */

function escapeHtml(unsafe){ return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }

function createWeaponNode(data={name:'New Weapon',attack:'+0',damage:'1d6',range:'',notes:''}){
  const wrapper=document.createElement('div'); wrapper.className='list-item';
  wrapper.innerHTML = `<div class="row">
      <div style="flex:1"><textarea class="dnd-input expandable" placeholder="Weapon Name">${escapeHtml(data.name)}</textarea></div>
      <div style="width:120px"><input class="dnd-input" placeholder="Attack bonus" value="${escapeHtml(data.attack)}"></div>
    </div>
    <div class="row">
      <div style="flex:1"><input class="dnd-input" placeholder="Damage" value="${escapeHtml(data.damage)}"></div>
      <div style="width:160px"><input class="dnd-input" placeholder="Range / Properties" value="${escapeHtml(data.range)}"></div>
    </div>
    <div class="row">
      <div style="flex:1"><textarea class="dnd-input expandable" placeholder="Notes">${escapeHtml(data.notes)}</textarea></div>
      <div style="width:60px;text-align:right"><button class="small-btn trash-btn" title="Remove weapon"><i data-feather="trash-2"></i></button></div>
    </div>`;
  const remove = wrapper.querySelector('.trash-btn'); remove.addEventListener('click', ()=>wrapper.remove());
  bindExpandableTextareas(wrapper);
  return wrapper;
}
function addWeapon(skipScroll=false){
  const node=createWeaponNode();
  document.getElementById('weapons-list').appendChild(node);
  feather.replace();
  annotateFieldsAndAutosize();
  bindExpandableTextareas(node);
  if(!skipScroll) node.scrollIntoView({behavior:'smooth',block:'center'});
}



function createArmorNode(data={name:'New Armor',ac:'10',type:'Light',stealth:'-',weight:'', notes:''}){
  const wrapper=document.createElement('div'); wrapper.className='list-item';
  wrapper.innerHTML = `<div class="row">
      <div style="flex:1"><textarea class="dnd-input expandable" placeholder="Armor Name">${escapeHtml(data.name)}</textarea></div>
      <div style="width:120px"><input class="dnd-input" placeholder="AC" value="${escapeHtml(data.ac)}"></div>
    </div>
    <div class="row">
      <div style="flex:1"><input class="dnd-input" placeholder="Type" value="${escapeHtml(data.type)}"></div>
      <div style="width:120px"><input class="dnd-input" placeholder="Stealth" value="${escapeHtml(data.stealth)}"></div>
    </div>
    <div class="row">
      <div style="flex:1"><input class="dnd-input" placeholder="Weight" value="${escapeHtml(data.weight)}"></div>
      <div style="width:60px;text-align:right"><button class="small-btn trash-btn" title="Remove armor"><i data-feather="trash-2"></i></button></div>
    </div>
    <div class="row">
      <div style="flex:1"><textarea class="dnd-input expandable" placeholder="Notes">${escapeHtml(data.notes)}</textarea></div>
    </div>`;
  const remove = wrapper.querySelector('.trash-btn'); remove.addEventListener('click', ()=>wrapper.remove());
  bindExpandableTextareas(wrapper);
  return wrapper;
}

// SPELLS: switch to tables; create rows for spells
function createSpellRow(type,data={name:'New Spell',level:'0',range:'',duration:'',desc:''}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><textarea class="dnd-input spell-name expandable" placeholder="Spell Name">${escapeHtml(data.name)}</textarea></td>
    <td style="width:90px"><select class="dnd-input spell-level"><option value="0">0 (Cantrip)</option>${[1,2,3,4,5,6,7,8,9].map(n=>`<option value="${n}">${n}</option>`).join('')}</select></td>
    <td style="width:120px"><input class="dnd-input" placeholder="Range" value="${escapeHtml(data.range)}"></td>
    <td style="width:120px"><input class="dnd-input" placeholder="Duration" value="${escapeHtml(data.duration)}"></td>
    <td><textarea class="dnd-input spell-desc" placeholder="Description">${escapeHtml(data.desc)}</textarea></td>
    <td style="width:60px;text-align:right"><button class="small-btn trash-btn">Remove</button></td>
  `;
  const removeBtn = tr.querySelector('.trash-btn'); removeBtn.addEventListener('click', ()=>tr.remove());
  // make row draggable and bind expandable textareas
  makeRowDraggable(tr);
  bindExpandableTextareas(tr);
  annotateFieldsAndAutosize();
  return tr;
}
function addArmor(skipScroll=false){
  const node=createArmorNode();
  document.getElementById('armor-list').appendChild(node);
  feather.replace();
  annotateFieldsAndAutosize();
  bindExpandableTextareas(node);
  if(!skipScroll) node.scrollIntoView({behavior:'smooth',block:'center'});
}

function addSpell(type, skipScroll=false){
  const target = (type==='cantrip')?document.querySelector('#cantrips-table tbody'):document.querySelector('#prepared-table tbody');
  const r=createSpellRow(type);
  target.appendChild(r);
  feather.replace();
  annotateFieldsAndAutosize();
  bindExpandableTextareas(r);
  enableSpellDnD(target);
  if(!skipScroll) r.scrollIntoView({behavior:'smooth',block:'center'});
}


// --- PORTRAIT HELPERS ---
function applyPortraitUrl(){
  const url=document.getElementById('portrait-url').value.trim();
  if(!url) return;
  try{
    const lower=url.toLowerCase();
    if(lower.includes('imgur.com') && !lower.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)){
      const id = url.split('/').pop().split('?')[0];
      const guesses = [`https://i.imgur.com/${id}.png`,`https://i.imgur.com/${id}.jpg`,`https://i.imgur.com/${id}.gif`];
      let tried=0;
      function tryNext(){
        if(tried>=guesses.length){ document.getElementById('character-portrait').src=url; return; }
        const g=guesses[tried++];
        const i=new Image();
        i.crossOrigin='anonymous';
        i.onload=()=>{document.getElementById('character-portrait').src=g};
        i.onerror=()=>tryNext();
        i.src=g;
      }
      tryNext();
    } else {
      const i = new Image();
      i.crossOrigin='anonymous';
      i.onload=()=>{document.getElementById('character-portrait').src=url};
      i.onerror=()=>{document.getElementById('character-portrait').src=url};
      i.src=url;
    }
  }catch(e){
    document.getElementById('character-portrait').src=url;
  }
}

function updatePortrait(input){ if(input.files && input.files[0]){ const reader=new FileReader(); reader.onload=e=>document.getElementById('character-portrait').src=e.target.result; reader.readAsDataURL(input.files[0]); }}

// --- SAVE (download HTML snapshot) ---
function saveCharacterSheet(){
  document.querySelectorAll('input, textarea, select').forEach(el=>{
    const tag = (el.tagName || '').toLowerCase();
    if(tag === 'input'){
      const type = (el.type || '').toLowerCase();
      if(type === 'checkbox' || type === 'radio'){
        if(el.checked) el.setAttribute('checked','checked'); else el.removeAttribute('checked');
      } else {
        el.setAttribute('value', el.value);
      }
    } else if(tag === 'textarea'){
      el.textContent = el.value;
    } else if(tag === 'select'){
      Array.from(el.options).forEach(opt=>{
        if(opt.selected) opt.setAttribute('selected','selected'); else opt.removeAttribute('selected');
      });
    }
  });

  const htmlContent='<!doctype html>\n'+document.documentElement.outerHTML;
  const blob=new Blob([htmlContent],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  const name=(document.getElementById('character-name').value||'character').replace(/\s+/g,'_');
  a.download = name + '_sheet.html';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// --- INVENTORY: Table/Containers system (Notes -> Description text box) ---
function createInventoryRow(data = { name: 'Item', qty: 1, weight: '', value: '', description: '' }){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><textarea class="dnd-input expandable" placeholder="Item name" style="width:100%">${escapeHtml(data.name)}</textarea></td>
    <td style="width:90px"><input class="dnd-input" placeholder="Qty" value="${escapeHtml(data.qty)}" style="width:100%"></td>
    <td style="width:90px"><input class="dnd-input" placeholder="Weight" value="${escapeHtml(data.weight)}" style="width:100%"></td>
    <td style="width:110px"><input class="dnd-input" placeholder="Value" value="${escapeHtml(data.value)}" style="width:100%"></td>
    <td><textarea class="dnd-input" placeholder="Description...">${escapeHtml(data.description)}</textarea></td>
    <td style="width:60px;text-align:right">
      <button class="small-btn trash-btn" title="Remove">Remove</button>
    </td>
  `;
  const removeBtn = tr.querySelector('.trash-btn'); removeBtn.addEventListener('click', ()=>tr.remove());
  bindExpandableTextareas(tr);
  return tr;
}

function createContainerNode(name = 'Container', data = { items: [] }){
  const wrapper = document.createElement('div');
  wrapper.className = 'mt-4';

  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const h = document.createElement('h4'); h.className='font-semibold'; h.textContent = name;
  header.appendChild(h);

  const controls = document.createElement('div');
  const addBtn = document.createElement('button'); addBtn.className='small-btn'; addBtn.innerHTML = '<i data-feather="plus"></i> Add Item';
  const renameBtn = document.createElement('button'); renameBtn.className='small-btn'; renameBtn.style.marginLeft='.4rem'; renameBtn.textContent='Rename';
  const removeBtn = document.createElement('button'); removeBtn.className='small-btn trash-btn'; removeBtn.style.marginLeft='.4rem'; removeBtn.textContent='Remove';
  controls.appendChild(addBtn); controls.appendChild(renameBtn); controls.appendChild(removeBtn);
  header.appendChild(controls);
  wrapper.appendChild(header);

  const table = document.createElement('table'); table.className='inventory-table';
  table.innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Weight</th><th>Value</th><th>Description</th><th></th></tr></thead><tbody></tbody>`;
  wrapper.appendChild(table);

  const tbody = table.querySelector('tbody');

  addBtn.addEventListener('click', ()=>{ const r=createInventoryRow(); tbody.appendChild(r); feather.replace(); annotateFieldsAndAutosize(); bindExpandableTextareas(r); r.scrollIntoView({behavior:'smooth',block:'center'}); });
  renameBtn.addEventListener('click', ()=>{ const newName = prompt('Container name:', h.textContent); if(newName) h.textContent = newName; });
  removeBtn.addEventListener('click', ()=> wrapper.remove());

  if(Array.isArray(data.items) && data.items.length){
    data.items.forEach(it=>tbody.appendChild(createInventoryRow(it)));
  }

  return wrapper;
}

function promptAddContainer(){
  const name = prompt('Container name (e.g., Equipped, Backpack, Pouch):','New Container');
  if(name) addContainer(name);
}

function addContainer(name, data, skipScroll=false){
  const container = createContainerNode(name || 'New Container', data || {});
  document.getElementById('inventory-containers').appendChild(container);
  feather.replace();
  annotateFieldsAndAutosize();
  bindExpandableTextareas(container);
  if(!skipScroll) container.scrollIntoView({behavior:'smooth',block:'center'});
}


function seedInventory(){
  const containerRoot = document.getElementById('inventory-containers');
  if(containerRoot.children.length === 0){
    addContainer('Equipped', { items: [ {name:'Longsword',qty:1,weight:'3',value:'15 gp',description:'A trusty blade.'} ] }, true);
    addContainer('Backpack', { items: [ {name:'Rations',qty:5,weight:'2',value:'5 gp',description:'Dried meals'} ] }, true);
    addContainer('Pouch', {}, true);
  }
}

// --- Spellcasting: allow multiple casting abilities ---
function createSpellcastingRow(ability='int'){
  const div = document.createElement('div'); div.className='spellcasting-row';
  div.innerHTML = `
    <div style="flex:1;min-width:160px">
      <div class="field-title">Spellcasting Ability</div>
      <select class="dnd-input spellcasting-select">
        <option value="int">Intelligence</option>
        <option value="wis">Wisdom</option>
        <option value="cha">Charisma</option>
      </select>
    </div>
    <div style="width:160px;min-width:120px">
      <div class="field-title">Spell Save DC</div>
      <input class="dnd-input spell-save-dc" readonly>
    </div>
    <div style="width:160px;min-width:120px">
      <div class="field-title">Spell Attack Bonus</div>
      <input class="dnd-input spell-attack-bonus" readonly>
    </div>
    <div class="control-group" style="margin-left:auto">
      <button class="small-btn remove-casting" title="Remove casting ability">Remove</button>
    </div>
  `;
  div.querySelector('.spellcasting-select').value = ability;
  div.querySelector('.remove-casting').addEventListener('click', ()=>{ div.remove(); updateModifiers(); });
  div.querySelector('.spellcasting-select').addEventListener('input', ()=>updateModifiers());
  return div;
}

const spellcastingList = document.getElementById('spellcasting-list');
if(spellcastingList.children.length===0) spellcastingList.appendChild(createSpellcastingRow('int'));
document.getElementById('add-casting-btn').addEventListener('click', ()=>{ spellcastingList.appendChild(createSpellcastingRow('int')); feather.replace(); annotateFieldsAndAutosize(); updateModifiers(); });

// --- Notes modal functions (kept for compatibility) ---
let _notesModalTarget = null;
function openNotesModal(textarea, notesDiv){
  _notesModalTarget = textarea;
  const modal = document.getElementById('item-notes-modal');
  const modalText = document.getElementById('item-notes-modal-text');
  modalText.value = textarea.value || '';
  modal.style.display = 'flex';
  modalText.focus();
}
function closeNotesModal(){ document.getElementById('item-notes-modal').style.display='none'; _notesModalTarget=null; }
function saveNotesModal(){ const modalText = document.getElementById('item-notes-modal-text'); if(_notesModalTarget) _notesModalTarget.value = modalText.value; closeNotesModal(); }

if(document.getElementById('weapons-list').children.length===0) addWeapon(true);
if(document.getElementById('armor-list').children.length===0) addArmor(true);
if(document.querySelector('#cantrips-table tbody').children.length===0) addSpell('cantrip', true);
if(document.querySelector('#prepared-table tbody').children.length===0) addSpell('prepared', true);

seedInventory();

setTimeout(()=>{ annotateFieldsAndAutosize(); bindExpandableTextareas(); updateModifiers();
// enable DnD on existing spell tables
  enableSpellDnD(document.querySelector('#cantrips-table tbody'));
  enableSpellDnD(document.querySelector('#prepared-table tbody'));
},120);

const observer = new MutationObserver(()=>{ feather.replace(); });
observer.observe(document.body, { childList:true, subtree:true });
</script>

<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "303d6224224f40b6b11286fa05c0bd06"}'></script><!-- End Cloudflare Web Analytics -->

<footer style="margin-top:2rem; padding:1rem; text-align:center; font-size:0.85rem; color:#555; border-top:1px solid #ccc;">
  <p>© 2025 Michael Garcia. This character sheet code and design is released for free use under the
    <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">Creative Commons Attribution 4.0 License</a>.
  </p>
  <p>You are free to share and adapt this sheet with credit. This project is a fan-made tool and is not affiliated with or endorsed by Wizards of the Coast.</p>
</footer>
</body>
</html>
