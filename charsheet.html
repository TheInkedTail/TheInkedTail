<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D&D Character Sheet — Full</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=IM+Fell+English&display=swap" rel="stylesheet">

  <style>
    :root{
      --parchment:#f6efe2;
      --paper:#fffdf8;
      --ink:#2b1f17;
      --accent:#7b2f2f;
      --border:#66402c;
      --gold:#d5b67a;
    }
    html,body{height:100%;}
    body{font-family: 'IM Fell English', Georgia, serif;background:linear-gradient(180deg,var(--parchment),#efe6d8);color:var(--ink);margin:0;padding:0}
    .topbar{position:sticky;top:0;z-index:80;background:linear-gradient(180deg,var(--accent),#4f1a1a);color:white;padding:.5rem 1rem;border-bottom:4px solid rgba(0,0,0,0.25);box-shadow:0 6px 18px rgba(0,0,0,0.25)}
    .topbar a{color:rgba(255,255,255,0.95);text-decoration:none;padding:.35rem .6rem;border-radius:6px;font-weight:700}
    .topbar .btn{background:linear-gradient(180deg,var(--gold),#b88a40);padding:.4rem .7rem;border-radius:6px;color:#2b1f17;font-weight:700}
    .container{max-width:1200px;margin:1rem auto;padding:1rem}
    .sheet-section{background:var(--paper);border:3px solid var(--border);border-radius:12px;padding:1rem;box-shadow:0 10px 30px rgba(17,12,8,0.12);overflow:hidden;margin-bottom:1rem}
    .dnd-input{display:block;width:100%;padding:.45rem .6rem;border:1px solid rgba(0,0,0,0.12);border-radius:8px;background:linear-gradient(180deg,#fff,#fbf6ee);min-height:36px;box-sizing:border-box}
    textarea.dnd-input{min-height:3.4rem;resize:vertical}
    .portrait{width:150px;height:150px;border-radius:10px;overflow:hidden;border:4px solid var(--border);background:linear-gradient(180deg,#fffdf7,#fbf2df)}
    .portrait img{width:100%;height:100%;object-fit:cover;display:block}
    .ability-block{display:flex;flex-direction:column;align-items:center;padding:.6rem;border-radius:8px;border:1px dashed rgba(0,0,0,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(250,245,235,0.9))}
    .skill-proficiency{width:26px;height:26px;border-radius:6px;border:2px solid var(--accent);display:inline-grid;place-items:center;font-weight:700;cursor:pointer;user-select:none;background:linear-gradient(180deg,#fff,#f4efe2)}
    .skill-proficiency[data-pro="0"]{opacity:0.35}
    .list-stack{display:flex;flex-direction:column;gap:.6rem}
    .list-item{background:linear-gradient(180deg,#fff,#fbf6ee);border:2px solid rgba(0,0,0,0.06);padding:.6rem;border-radius:8px;display:flex;flex-direction:column;gap:.4rem}
    .small-btn{padding:.35rem .6rem;border-radius:6px;background:#efe7d1;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
    .row{display:flex;gap:.6rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.4rem}
    @media print{
      body{background:white;color:black}
      .topbar{display:none}
      .container{max-width:100%;padding:0}
      .sheet-section{border:none;box-shadow:none}
      .small-btn,.trash-btn{display:none}
    }
    @media (max-width:900px){
      .portrait{width:110px;height:110px}
      .row{flex-direction:column;align-items:stretch}
    }

    /* Inventory table styles — match theme */
    .inventory-table{width:100%;border-collapse:collapse;margin-top:.5rem;font-size:0.95rem}
    .inventory-table th,.inventory-table td{border:1px solid var(--border);padding:.3rem;text-align:left;background:transparent}
    .inventory-table th{background:linear-gradient(180deg,#efe0bb,#e0d4b7);font-weight:700}
    .notes{display:none;margin-top:.3rem;padding:.3rem;border:1px dashed var(--border);background:#faf7f0}
    .notes-open{display:block}
    .notes-btn{cursor:pointer;font-size:0.85rem;color:var(--accent);text-decoration:underline;background:none;border:none;padding:0}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container flex justify-between items-center">
      <nav class="flex gap-2 items-center">
        <a href="#char-info">Character</a>
        <a href="#abilities">Abilities</a>
        <a href="#combat">Combat</a>
        <a href="#spells">Spells</a>
        <a href="#inventory">Inventory</a>
        <a href="#details">Details</a>
      </nav>
      <div class="flex gap-2">
        <button class="btn" onclick="saveCharacterSheet()"><i data-feather="save"></i> Save</button>
        <button class="btn secondary" onclick="window.print()"><i data-feather="printer"></i> Print</button>
      </div>
    </div>
  </div>

  <div class="container">
    <header class="text-center">
      <h1 style="font-family:'Cinzel',serif;font-size:28px;margin:0;color:var(--accent)">Dungeons & Dragons — Character Sheet</h1>
      <p style="margin:.2rem 0 .8rem;color:rgba(0,0,0,0.55)">Restored inventory, spells, weapons, armor — with fixes and improved styling.</p>
    </header>

    <!-- CHARACTER INFO -->
    <section id="char-info" class="sheet-section grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="row items-start">
        <div class="portrait" id="portrait-box"><img id="character-portrait" src="https://placekitten.com/300/300" alt="portrait"></div>
        <div style="flex:1">
          <div class="col">
            <input id="character-name" class="dnd-input text-2xl font-bold" placeholder="Character Name">
            <div class="grid grid-cols-2 gap-2">
              <input id="character-class" class="dnd-input" placeholder="Class & Level">
              <input id="character-race" class="dnd-input" placeholder="Race">
              <input id="player-name" class="dnd-input" placeholder="Player">
              <input id="character-background" class="dnd-input" placeholder="Background">
            </div>
          </div>
        </div>
      </div>

      <div>
        <div class="col">
          <div class="grid grid-cols-2 gap-2">
            <input id="character-alignment" class="dnd-input" placeholder="Alignment">
            <input id="character-xp" class="dnd-input" type="number" placeholder="XP">
            <input id="character-ac" class="dnd-input" type="number" placeholder="AC">
            <input id="character-initiative" class="dnd-input" type="number" placeholder="Initiative">
            <input id="character-speed" class="dnd-input" placeholder="Speed">
            <input id="proficiency-bonus" class="dnd-input" type="number" value="2" placeholder="Proficiency">
          </div>
        </div>
      </div>

      <div>
        <div class="col">
          <div class="row">
            <input id="character-hp-current" class="dnd-input" type="number" placeholder="Current HP">
            <input id="character-hp-max" class="dnd-input" type="number" placeholder="Max HP">
          </div>
          <input id="character-hit-dice" class="dnd-input" placeholder="Hit Dice">
          <div class="row" style="align-items:center">
            <input id="portrait-url" class="dnd-input" placeholder="Portrait image URL (works with Imgur links)">
            <button class="small-btn" onclick="applyPortraitUrl()">Apply</button>
          </div>
          <input id="portrait-input" type="file" accept="image/*" class="mt-1" onchange="updatePortrait(this)">
        </div>
      </div>
    </section>

    <!-- ABILITIES / SKILLS / COMBAT -->
    <section id="abilities" class="sheet-section grid grid-cols-1 lg:grid-cols-4 gap-6">
      <div>
        <h3 class="font-bold">Ability Scores</h3>
        <div class="grid grid-cols-3 gap-2 mt-2" id="abilities-grid"></div>

        <div class="mt-4">
          <h4 class="font-semibold">Saving Throws</h4>
          <div id="saves-list" class="space-y-2 mt-2"></div>
        </div>

        <div class="mt-3">
          <div class="row">
            <label class="col">
              <span>Inspiration</span>
              <input type="checkbox" id="inspiration">
            </label>
            <label class="col">
              <span>Passive Perception</span>
              <input id="passive-perception" class="dnd-input" readonly>
            </label>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        <h3 class="font-bold">Skills</h3>
        <div id="skills-list" class="space-y-2 mt-2"></div>
      </div>

      <div>
        <h3 class="font-bold">Features & Traits</h3>
        <label class="text-sm mt-1">Class Features</label>
        <textarea id="class-features" class="dnd-input w-full h-28"></textarea>
        <label class="text-sm mt-2">Racial Traits</label>
        <textarea id="racial-traits" class="dnd-input w-full h-20"></textarea>
      </div>

      <div id="combat">
        <h3 class="font-bold">Combat</h3>
        <div>
          <label class="block text-sm">Weapons</label>
          <div id="weapons-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addWeapon()"><i data-feather="plus"></i> Add Weapon</button></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm">Armor</label>
          <div id="armor-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addArmor()"><i data-feather="plus"></i> Add Armor</button></div>
        </div>

        <div class="mt-4">
          <label class="block text-sm">Passive Investigation</label>
          <input id="passive-investigation" class="dnd-input w-full" readonly>
        </div>
      </div>
    </section>

    <!-- SPELLS -->
    <section id="spells" class="sheet-section">
      <h3 class="font-bold">Spells</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mt-2">
        <div>
          <label class="text-sm">Spellcasting Ability</label>
          <select id="spellcasting-ability" class="dnd-input w-full">
            <option value="int">Intelligence</option>
            <option value="wis">Wisdom</option>
            <option value="cha">Charisma</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Spell Save DC</label>
          <input id="spell-save-dc" class="dnd-input w-full" readonly>
        </div>
        <div>
          <label class="text-sm">Spell Attack Bonus</label>
          <input id="spell-attack-bonus" class="dnd-input w-full" readonly>
        </div>
        <div>
          <label class="text-sm">Search</label>
          <input id="spell-filter" class="dnd-input w-full" placeholder="Filter spells by name..." oninput="renderSpells()">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <h4 class="font-semibold">Cantrips</h4>
          <div id="cantrips-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addSpell('cantrip')"><i data-feather="plus"></i> Add Cantrip</button></div>
        </div>

        <div>
          <h4 class="font-semibold">Prepared Spells</h4>
          <div id="prepared-spells-list" class="list-stack mt-2"></div>
          <div class="mt-2"><button class="small-btn" onclick="addSpell('prepared')"><i data-feather="plus"></i> Add Spell</button></div>
        </div>

        <div>
          <h4 class="font-semibold">Spell Details</h4>
          <textarea id="spell-description" class="dnd-input w-full h-40" placeholder="Select a spell to view or edit its full description"></textarea>
        </div>
      </div>
    </section>

    <!-- INVENTORY (REPLACED / IMPROVED) -->
    <section id="inventory" class="sheet-section">
      <h3 class="font-bold">Inventory</h3>

      <!-- Inventory containers render here -->
      <div id="inventory-containers" style="margin-top:.5rem;"></div>

      <!-- master add container -->
      <div style="margin-top:.75rem;">
        <button class="small-btn" onclick="promptAddContainer()">+ Add Container</button>
      </div>

      <!-- currency & encumbrance -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold">Currency</h4>
          <div class="grid grid-cols-5 gap-2 mt-2">
            <input id="currency-cp" class="dnd-input" placeholder="CP" type="number">
            <input id="currency-sp" class="dnd-input" placeholder="SP" type="number">
            <input id="currency-ep" class="dnd-input" placeholder="EP" type="number">
            <input id="currency-gp" class="dnd-input" placeholder="GP" type="number">
            <input id="currency-pp" class="dnd-input" placeholder="PP" type="number">
          </div>
        </div>
        <div>
          <h4 class="font-semibold">Encumbrance</h4>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <input id="carried-weight" class="dnd-input" placeholder="Carried" type="number">
            <input id="max-capacity" class="dnd-input" placeholder="Max" type="number">
            <input id="encumbrance-status" class="dnd-input" placeholder="Status" readonly>
          </div>
        </div>
      </div>

      <!-- Notes modal hidden until used -->
      <div id="item-notes-modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:120;">
        <div style="background:var(--paper);border:3px solid var(--border);padding:1rem;border-radius:8px;max-width:700px;width:94%;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Item Notes</strong>
            <div>
              <button class="small-btn" onclick="closeNotesModal()">Close</button>
            </div>
          </div>
          <textarea id="item-notes-modal-text" class="dnd-input" style="margin-top:.6rem;min-height:180px;"></textarea>
          <div style="margin-top:.6rem;text-align:right;">
            <button class="small-btn" onclick="saveNotesModal()">Save</button>
          </div>
        </div>
        <div onclick="closeNotesModal()" style="position:fixed;inset:0;background:rgba(0,0,0,0.35)"></div>
      </div>

    </section>

    <!-- DETAILS -->
    <section id="details" class="sheet-section">
      <h3 class="font-bold">Character Details</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
        <div>
          <label class="text-sm">Appearance</label>
          <textarea id="character-appearance" class="dnd-input w-full h-40"></textarea>
        </div>
        <div>
          <label class="text-sm">Backstory</label>
          <textarea id="character-backstory" class="dnd-input w-full h-40"></textarea>
        </div>
        <div>
          <label class="text-sm">Vitals</label>
          <div class="grid grid-cols-2 gap-2 mt-1">
            <input id="detail-height" class="dnd-input" placeholder="Height">
            <input id="detail-weight" class="dnd-input" placeholder="Weight">
            <input id="detail-age" class="dnd-input" placeholder="Age">
            <input id="detail-eyes" class="dnd-input" placeholder="Eyes">
            <input id="detail-skin" class="dnd-input" placeholder="Skin">
            <input id="detail-hair" class="dnd-input" placeholder="Hair">
          </div>
          <label class="text-sm mt-2">Allies & Organizations</label>
          <textarea id="character-allies" class="dnd-input w-full h-24"></textarea>
        </div>
      </div>
    </section>
  </div>

<script>
feather.replace();

// --- Core data for abilities & skills ---
const abilities = [
  {abbr:'STR',id:'str'}, {abbr:'DEX',id:'dex'}, {abbr:'CON',id:'con'},
  {abbr:'INT',id:'int'}, {abbr:'WIS',id:'wis'}, {abbr:'CHA',id:'cha'}
];

const skills = [
  {id:'acrobatics',label:'Acrobatics',ability:'dex'}, {id:'animal-handling',label:'Animal Handling',ability:'wis'},
  {id:'arcana',label:'Arcana',ability:'int'}, {id:'athletics',label:'Athletics',ability:'str'},
  {id:'deception',label:'Deception',ability:'cha'}, {id:'history',label:'History',ability:'int'},
  {id:'insight',label:'Insight',ability:'wis'}, {id:'intimidation',label:'Intimidation',ability:'cha'},
  {id:'investigation',label:'Investigation',ability:'int'}, {id:'medicine',label:'Medicine',ability:'wis'},
  {id:'nature',label:'Nature',ability:'int'}, {id:'perception',label:'Perception',ability:'wis'},
  {id:'performance',label:'Performance',ability:'cha'}, {id:'persuasion',label:'Persuasion',ability:'cha'},
  {id:'religion',label:'Religion',ability:'int'}, {id:'sleight-of-hand',label:'Sleight of Hand',ability:'dex'},
  {id:'stealth',label:'Stealth',ability:'dex'}, {id:'survival',label:'Survival',ability:'wis'}
];

// BUILDERS (only build if empty to prevent duplication on saved pages)
const abilitiesGrid = document.getElementById('abilities-grid');
if (abilitiesGrid && abilitiesGrid.children.length === 0) {
  abilities.forEach(a=>{
    const el = document.createElement('div'); el.className='ability-block';
    el.innerHTML = `<div style="font-weight:700">${a.abbr}</div>
      <input type="number" min="1" max="30" class="dnd-input ability-score text-center" data-ability="${a.id}" value="10">
      <div>Mod: <span class="ability-mod">+0</span></div>`;
    abilitiesGrid.appendChild(el);
  });
}

const savesList = document.getElementById('saves-list');
if (savesList && savesList.children.length === 0) {
  abilities.forEach(a=>{
    const row = document.createElement('div'); row.className='row'; row.style.alignItems='center';
    row.innerHTML = `<div style="width:36px"><div class="skill-proficiency" data-skill="${a.id}-save" data-pro="0">–</div></div>
      <div style="flex:1;font-weight:700">${a.abbr} Save</div>
      <div style="width:48px;text-align:right;font-weight:700" id="${a.id}-save-mod">+0</div>`;
    savesList.appendChild(row);
  });
}

const skillsList = document.getElementById('skills-list');
if (skillsList && skillsList.children.length === 0) {
  skills.forEach(s=>{
    const row = document.createElement('div'); row.className='row'; row.style.alignItems='center';
    row.innerHTML = `<div style="width:36px"><div class="skill-proficiency" data-skill="${s.id}" data-pro="0">–</div></div>
      <div style="flex:1">${s.label} <span style="font-size:.8rem;color:rgba(0,0,0,0.45);">(${s.ability.toUpperCase()})</span></div>
      <div style="width:48px;text-align:right;font-weight:700" id="${s.id}-mod">+0</div>`;
    skillsList.appendChild(row);
  });
}

// Proficiency cycling and modifier calculations
function cyclePro(el){
  const cur = parseInt(el.getAttribute('data-pro')||'0'); const next = (cur+1)%4;
  el.setAttribute('data-pro',next);
  const icons = ['','½','●','★']; el.textContent = icons[next] || '';
  updateModifiers();
}
document.addEventListener('click',(e)=>{
  const el = e.target.closest('.skill-proficiency'); if(el) cyclePro(el);
});

function calcMod(score){ return Math.floor((score-10)/2); }

function updateModifiers(){
  const prof = parseInt(document.getElementById('proficiency-bonus').value)||0;
  document.querySelectorAll('.ability-score').forEach(inp=>{
    const score = parseInt(inp.value)||0; const mod = calcMod(score);
    inp.parentElement.querySelector('.ability-mod').textContent = (mod>=0?'+':'')+mod;
  });
  abilities.forEach(a=>{
    const base = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${a.id}"]`).value||10));
    const protEl = document.querySelector(`.skill-proficiency[data-skill="${a.id}-save"]`); const level = parseInt(protEl.getAttribute('data-pro')||0);
    let add=0; if(level===1) add=Math.ceil(prof/2); if(level===2) add=prof; if(level===3) add=prof*2;
    document.getElementById(`${a.id}-save-mod`).textContent = (base+add>=0?'+':'')+(base+add);
  });
  skills.forEach(s=>{
    const base = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${s.ability}"]`).value||10));
    const protEl = document.querySelector(`.skill-proficiency[data-skill="${s.id}"]`); const level = parseInt(protEl.getAttribute('data-pro')||0);
    let add=0; if(level===1) add=Math.ceil(prof/2); if(level===2) add=prof; if(level===3) add=prof*2;
    document.getElementById(`${s.id}-mod`).textContent = (base+add>=0?'+':'')+(base+add);
  });

  const perBase = calcMod(parseInt(document.querySelector('.ability-score[data-ability="wis"]').value||10));
  const perProt = parseInt(document.querySelector(`.skill-proficiency[data-skill="perception"]`).getAttribute('data-pro')||0);
  let perAdd=0; if(perProt===1) perAdd=Math.ceil(prof/2); if(perProt===2) perAdd=prof; if(perProt===3) perAdd=prof*2;
  document.getElementById('passive-perception').value = 10 + perBase + perAdd;

  const invBase = calcMod(parseInt(document.querySelector('.ability-score[data-ability="int"]').value||10));
  const invProt = parseInt(document.querySelector(`.skill-proficiency[data-skill="investigation"]`).getAttribute('data-pro')||0);
  let invAdd=0; if(invProt===1) invAdd=Math.ceil(prof/2); if(invProt===2) invAdd=prof; if(invProt===3) invAdd=prof*2;
  document.getElementById('passive-investigation').value = 10 + invBase + invAdd;

  const spellAbility = document.getElementById('spellcasting-ability').value;
  const spellMod = calcMod(parseInt(document.querySelector(`.ability-score[data-ability="${spellAbility}"]`).value||10));
  document.getElementById('spell-save-dc').value = 8 + prof + spellMod;
  document.getElementById('spell-attack-bonus').value = prof + spellMod;
}
document.addEventListener('input',(e)=>{ if(e.target && (e.target.classList.contains('ability-score')||e.target.id==='proficiency-bonus'||e.target.id==='spellcasting-ability')) updateModifiers(); });

// --- Weapons / Armor / Spells (re-usable create/add functions) ---
function escapeHtml(unsafe){ return String(unsafe).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

function createWeaponNode(data={name:'New Weapon',attack:'+0',damage:'1d6',notes:''}){
  const wrapper=document.createElement('div'); wrapper.className='list-item';
  wrapper.innerHTML = `<div class="row"><input class="dnd-input" placeholder="Weapon Name" value="${escapeHtml(data.name)}"><input class="dnd-input" placeholder="Attack bonus" value="${escapeHtml(data.attack)}"></div>
  <div class="row"><input class="dnd-input" placeholder="Damage" value="${escapeHtml(data.damage)}"><input class="dnd-input" placeholder="Range / Properties" value="${escapeHtml(data.notes)}"></div>
  <div class="row" style="justify-content:flex-end"><button class="small-btn trash-btn" onclick="this.closest('.list-item').remove()"><i data-feather="trash-2"></i></button></div>`;
  return wrapper;
}
function addWeapon(){ const node=createWeaponNode(); document.getElementById('weapons-list').appendChild(node); feather.replace(); node.scrollIntoView({behavior:'smooth',block:'center'}); }

function createArmorNode(data={name:'New Armor',ac:'10',type:'Light',stealth:'-',weight:''}){
  const wrapper=document.createElement('div'); wrapper.className='list-item';
  wrapper.innerHTML = `<div class="row"><input class="dnd-input" placeholder="Armor Name" value="${escapeHtml(data.name)}"><input class="dnd-input" placeholder="AC" value="${escapeHtml(data.ac)}"></div>
  <div class="row"><input class="dnd-input" placeholder="Type" value="${escapeHtml(data.type)}"><input class="dnd-input" placeholder="Stealth" value="${escapeHtml(data.stealth)}"></div>
  <div class="row" style="justify-content:flex-end"><button class="small-btn trash-btn" onclick="this.closest('.list-item').remove()"><i data-feather="trash-2"></i></button></div>`;
  return wrapper;
}
function addArmor(){ const node=createArmorNode(); document.getElementById('armor-list').appendChild(node); feather.replace(); node.scrollIntoView({behavior:'smooth',block:'center'}); }

function createSpellNode(type,data={name:'New Spell',level:'0',range:'',duration:'',desc:''}){
  const wrapper=document.createElement('div'); wrapper.className='list-item';
  const levelSelect = `<select class="dnd-input spell-level" style="width:100px"><option value="0">0 (Cantrip)</option>${[1,2,3,4,5,6,7,8,9].map(n=>`<option value="${n}">${n}</option>`).join('')}</select>`;
  wrapper.innerHTML = `<div class="row"><input class="dnd-input spell-name" placeholder="Spell Name" value="${escapeHtml(data.name)}">${levelSelect}</div>
    <div class="row"><input class="dnd-input" placeholder="Range" value="${escapeHtml(data.range)}"><input class="dnd-input" placeholder="Duration" value="${escapeHtml(data.duration)}"></div>
    <textarea class="dnd-input" placeholder="Description">${escapeHtml(data.desc)}</textarea>
    <div class="row" style="justify-content:space-between"><div><button class="small-btn" onclick="selectSpell(this)">Open</button></div><div><button class="small-btn trash-btn" onclick="this.closest('.list-item').remove()"><i data-feather="trash-2"></i></button></div></div>`;
  return wrapper;
}
function addSpell(type){ const target=(type==='cantrip')?'cantrips-list':'prepared-spells-list'; const node=createSpellNode(type); document.getElementById(target).appendChild(node); feather.replace(); node.scrollIntoView({behavior:'smooth',block:'center'}); }
function selectSpell(btn){ const li=btn.closest('.list-item'); document.getElementById('spell-description').value = li.querySelector('.spell-name').value + "\n\n" + li.querySelector('textarea').value; li.scrollIntoView({behavior:'smooth',block:'center'}); }

// --- PORTRAIT HELPERS ---
function applyPortraitUrl(){
  const url=document.getElementById('portrait-url').value.trim();
  if(!url) return;
  try{
    const lower=url.toLowerCase();
    if(lower.includes('imgur.com') && !lower.match(/\.(jpg|jpeg|png|gif|webp)(\?|$)/i)){
      const id = url.split('/').pop().split('?')[0];
      const guesses = [`https://i.imgur.com/${id}.png`,`https://i.imgur.com/${id}.jpg`,`https://i.imgur.com/${id}.gif`];
      let tried=0;
      function tryNext(){ if(tried>=guesses.length){ document.getElementById('character-portrait').src=url; return;} const g=guesses[tried++]; const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>{document.getElementById('character-portrait').src=g}; i.onerror=()=>tryNext(); i.src=g; }
      tryNext();
    } else {
      const i = new Image(); i.crossOrigin='anonymous'; i.onload=()=>{document.getElementById('character-portrait').src=url}; i.onerror=()=>{document.getElementById('character-portrait').src=url}; i.src=url;
    }
  }catch(e){ document.getElementById('character-portrait').src=url; }
}
function updatePortrait(input){ if(input.files && input.files[0]){ const reader=new FileReader(); reader.onload=e=>document.getElementById('character-portrait').src=e.target.result; reader.readAsDataURL(input.files[0]); }}

// --- SAVE (download HTML snapshot) ---
function saveCharacterSheet(){
  const htmlContent='<!doctype html>\n'+document.documentElement.outerHTML;
  const blob=new Blob([htmlContent],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url;
  const name=(document.getElementById('character-name').value||'character').replace(/\s+/g,'_');
  a.download = name + '_sheet.html';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// --- INVENTORY: Table/Containers system ---
// createInventoryRow: returns a <tr> element with columns Name | Qty | Weight | Value | Notes | Actions
function createInventoryRow(data = { name: 'Item', qty: 1, weight: '', value: '', notes: '' }){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="dnd-input" placeholder="Item name" value="${escapeHtml(data.name)}" style="width:100%"></td>
    <td style="width:90px"><input class="dnd-input" placeholder="Qty" value="${escapeHtml(data.qty)}" style="width:100%"></td>
    <td style="width:90px"><input class="dnd-input" placeholder="Weight" value="${escapeHtml(data.weight)}" style="width:100%"></td>
    <td style="width:110px"><input class="dnd-input" placeholder="Value" value="${escapeHtml(data.value)}" style="width:100%"></td>
    <td style="width:120px">
      <button class="notes-btn" type="button">Notes</button>
      <div class="notes"><textarea class="dnd-input" placeholder="Notes...">${escapeHtml(data.notes)}</textarea></div>
    </td>
    <td style="width:60px;text-align:right">
      <button class="small-btn trash-btn" title="Remove">Remove</button>
    </td>
  `;
  // wiring
  const notesBtn = tr.querySelector('.notes-btn');
  const notesDiv = tr.querySelector('.notes');
  const notesArea = notesDiv.querySelector('textarea');
  const removeBtn = tr.querySelector('.trash-btn');

  notesBtn.addEventListener('click', ()=>{
    // If notes area is hidden, expand inline; if already expanded, open modal for larger editing
    const isOpen = notesDiv.classList.contains('notes-open');
    if(!isOpen){
      notesDiv.classList.add('notes-open');
      notesDiv.style.display = 'block';
    } else {
      openNotesModal(notesArea, notesDiv);
    }
  });

  // double-click the notes textarea to open modal
  notesArea.addEventListener('dblclick', ()=>openNotesModal(notesArea, notesDiv));

  removeBtn.addEventListener('click', ()=>tr.remove());

  return tr;
}

// createContainerNode: returns a container <div> with header and an inventory table
function createContainerNode(name = 'Container', data = { items: [] }){
  const wrapper = document.createElement('div');
  wrapper.className = 'mt-4';

  const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const h = document.createElement('h4'); h.className='font-semibold'; h.textContent = name;
  header.appendChild(h);

  const controls = document.createElement('div');
  const addBtn = document.createElement('button'); addBtn.className='small-btn'; addBtn.innerHTML = '<i data-feather="plus"></i> Add Item';
  const renameBtn = document.createElement('button'); renameBtn.className='small-btn'; renameBtn.style.marginLeft='.4rem'; renameBtn.textContent='Rename';
  const removeBtn = document.createElement('button'); removeBtn.className='small-btn trash-btn'; removeBtn.style.marginLeft='.4rem'; removeBtn.textContent='Remove';
  controls.appendChild(addBtn); controls.appendChild(renameBtn); controls.appendChild(removeBtn);
  header.appendChild(controls);
  wrapper.appendChild(header);

  const table = document.createElement('table'); table.className='inventory-table';
  table.innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Weight</th><th>Value</th><th>Notes</th><th></th></tr></thead><tbody></tbody>`;
  wrapper.appendChild(table);

  const tbody = table.querySelector('tbody');

  addBtn.addEventListener('click', ()=>{ const r=createInventoryRow(); tbody.appendChild(r); feather.replace(); r.scrollIntoView({behavior:'smooth',block:'center'}); });
  renameBtn.addEventListener('click', ()=>{
    const newName = prompt('Container name:', h.textContent);
    if(newName) h.textContent = newName;
  });
  removeBtn.addEventListener('click', ()=> wrapper.remove());

  // seed items if passed
  if(Array.isArray(data.items) && data.items.length){
    data.items.forEach(it=>tbody.appendChild(createInventoryRow(it)));
  }

  return wrapper;
}

// promptAddContainer -> show prompt and create
function promptAddContainer(){
  const name = prompt('Container name (e.g., Equipped, Backpack, Pouch):','New Container');
  if(name) addContainer(name);
}

function addContainer(name, data){
  const container = createContainerNode(name || 'New Container', data || {});
  document.getElementById('inventory-containers').appendChild(container);
  feather.replace();
  container.scrollIntoView({behavior:'smooth',block:'center'});
}

// Notes modal functions
let _notesModalTarget = null;
function openNotesModal(textarea, notesDiv){
  _notesModalTarget = textarea;
  const modal = document.getElementById('item-notes-modal');
  const modalText = document.getElementById('item-notes-modal-text');
  modalText.value = textarea.value || '';
  modal.style.display = 'flex';
  modalText.focus();
}
function closeNotesModal(){ document.getElementById('item-notes-modal').style.display='none'; _notesModalTarget=null; }
function saveNotesModal(){ const modalText = document.getElementById('item-notes-modal-text'); if(_notesModalTarget) _notesModalTarget.value = modalText.value; closeNotesModal(); }

// seed default containers only if empty (prevents duplication when saved page re-runs)
function seedInventory(){
  const containerRoot = document.getElementById('inventory-containers');
  if(containerRoot.children.length === 0){
    addContainer('Equipped', { items: [ {name:'Longsword',qty:1,weight:'3',value:'15 gp',notes:'A trusty blade.'} ] });
    addContainer('Backpack', { items: [ {name:'Rations',qty:5,weight:'2',value:'5 gp',notes:'Dried meals'} ] });
    addContainer('Pouch'); // blank container
  }
}
seedInventory();

// initial seed for weapons/armor/spells/items to avoid empty UI if desired
if(document.getElementById('weapons-list').children.length===0) addWeapon();
if(document.getElementById('armor-list').children.length===0) addArmor();
if(document.getElementById('cantrips-list').children.length===0) addSpell('cantrip');
if(document.getElementById('prepared-spells-list').children.length===0) addSpell('prepared');

// initialize modifiers
updateModifiers();
</script>
</body>
</html>
